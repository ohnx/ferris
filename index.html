<!DOCTYPE>

<html>

  <head>
    <title>cytoscape-edgehandles.js snapping demo</title>

    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.20.0/cytoscape.min.js" integrity="sha512-cjmYAonfXK+azDmWqvnqq8xmygHRHqVI7S0zuRxQnvcYVeoakwthRX6pPKoXfG1oIjDvMUtteRV9PhQjJwKWxQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.10/lodash.js"></script>
    <script src="https://rawcdn.githack.com/cytoscape/cytoscape.js-edgehandles/745c4f2b2581b66c4a2324374e87a5d07910141d/cytoscape-edgehandles.js?min=1"></script>

    <style>
      body {
        font-family: helvetica neue, helvetica, liberation sans, arial, sans-serif;
        font-size: 14px;
      }

      #cy {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        right: 0;
        z-index: 999;
      }

      h1 {
        opacity: 0.5;
        font-size: 1em;
        font-weight: bold;
      }

      #buttons {
        position: absolute;
        right: 0;
        top: 0;
        z-index: 99999;
        margin: 1em;
      }
    </style>

    <script>
const TEST_OBJ = {
  version: 1,
  machine: {
    nodes: [
      {
        // all nodes have an id and a name and that's it
        id: 0,
        // special case node 0 MUST BE called [RESET] to indicate where the
        // fsm starts upon reset
        name: "[RESET]"
      },
      {id: 1, name: "WAIT_READ"},
      {id: 2, name: "WAIT_WRITE"},
      {id: 3, name: "WRITE_DELAY"},
      {id: 4, name: "WRITE0"},
      {id: 5, name: "WRITE1"},
      {id: 6, name: "WRITE2"},
      {id: 7, name: "WRITE3"},
      // id's don't have to be sequential
    ],
    edges: [
      {
        // all edges describe a start, end, condition, and output
        start: 0,
        end: 1,
        condition: "[RESET]",
        output: []
      },
      // TODO: fsm's look nicer with ~ instead of !, can we use that instead?
      {start: 1, end: 1, condition: "fifo_empty", output: ["buf_en"]},
      {start: 1, end: 2, condition: "!fifo_empty", output: ["buf_en", "fifo_read"]},
      {start: 2, end: 3, condition: "free_outbound", output: []},
      {start: 2, end: 2, condition: "!free_outbound", output: []},
      {start: 3, end: 4, condition: "", output: ["put_outbound", "sel = 0"]},
      {start: 4, end: 5, condition: "", output: ["put_outbound", "sel = 1"]},
      {start: 5, end: 6, condition: "", output: ["put_outbound", "sel = 2"]},
      {start: 6, end: 7, condition: "", output: ["put_outbound", "sel = 3"]},
      {start: 7, end: 1, condition: "fifo_empty", output: ["buf_en"]},
      {start: 7, end: 2, condition: "!fifo_empty", output: ["buf_en", "fifo_read"]},
    ]
  },
  // additional metadata needed to build a proper representation
  meta: {
    name: "NFTB_fsm",
    signals: {
      // signals (input/output) 
      input: [
        {
          // input signals have a name and a width
          name: "fifo_empty",
          width: 1
        },
        {name: "free_outbound", width: 1}
      ],
      output: [
        // output signals also have an extra parameter:
        // for width = 1 signals, if they are inverted
        // inverted == true if they are ACTIVE LOW
        // inverted == false if they are ACTIVE HIGH
        // for width > 1 signals, a "default" setting (if not specified, defaults to 0)
        {name: "fifo_read", width: 1, inverted: false},
        {name: "buf_en", width: 1, inverted: false},
        {name: "sel", width: 2},
        {name: "put_outbound", width: 1, inverted: false}
      ]
    }
  }
};
    </script>

    <script>
      function hr_to_cyto(obj) {
        var elements = {};
        elements.nodes = obj.machine.nodes.map((x) => {return {data: x};});
        elements.edges = obj.machine.edges.map((x) => {
          let myVar = {data: x};
          myVar.data.source = x.start;
          myVar.data.target = x.end;
          myVar.data.name = `${x.condition} / ${x.output.join(',')}`;
          return myVar;
        });
        return elements;
      }

      document.addEventListener('DOMContentLoaded', function() {
        console.log(TEST_OBJ);
        console.log(hr_to_cyto(TEST_OBJ));

        var cy = window.cy = cytoscape({
          container: document.getElementById('cy'),

          layout: {
            name: 'concentric',
            concentric: function(n){ return n.id() === 'j' ? 200 : 0; },
            levelWidth: function(nodes){ return 100; },
            minNodeSpacing: 100
          },

          style: [
            {
              selector: 'node[name]',
              style: {
                'content': 'data(name)'
              }
            },

            {
              selector: 'edge',
              style: {
                'curve-style': 'bezier',
                'target-arrow-shape': 'triangle',
                'content': 'data(name)',
                'font-size': '12%'
              }
            },

            // some style for the extension

            {
              selector: '.eh-handle',
              style: {
                'background-color': 'red',
                'width': 12,
                'height': 12,
                'shape': 'ellipse',
                'overlay-opacity': 0,
                'border-width': 12, // makes the handle easier to hit
                'border-opacity': 0
              }
            },

            {
              selector: '.eh-hover',
              style: {
                'background-color': 'red'
              }
            },

            {
              selector: '.eh-source',
              style: {
                'border-width': 2,
                'border-color': 'red'
              }
            },

            {
              selector: '.eh-target',
              style: {
                'border-width': 2,
                'border-color': 'red'
              }
            },

            {
              selector: '.eh-preview, .eh-ghost-edge',
              style: {
                'background-color': 'red',
                'line-color': 'red',
                'target-arrow-color': 'red',
                'source-arrow-color': 'red'
              }
            },

            {
              selector: '.eh-ghost-edge.eh-preview-active',
              style: {
                'opacity': 0
              }
            }
          ],

          elements: hr_to_cyto(TEST_OBJ)
        });

        var eh = cy.edgehandles({
          snap: false
        });

        document.querySelector('#draw-on').addEventListener('click', function() {
          eh.enableDrawMode();
        });

        document.querySelector('#draw-off').addEventListener('click', function() {
          eh.disableDrawMode();
        });

        document.querySelector('#start').addEventListener('click', function() {
          eh.start( cy.$('node:selected') );
        });

      });
    </script>
  </head>

  <body>
    <h1>cytoscape-edgehandles (snapping disabled)</h1>

    <div id="cy"></div>

    <div id="buttons">
      <button id="start">Start on selected</button>
      <button id="draw-on">Draw mode on</button>
      <button id="draw-off">Draw mode off</button>
    </div>

  </body>

</html>
